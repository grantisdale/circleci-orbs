version: 2.1
description: | 
  Configure and revoke read tokens for packagecloud npm, maven (using gradle) and pypi repositories.This will allow CircleCI 
  jobs to get dependencies from packagecloud. 
  This orb works for npm, maven and pypi packagecloud repositories. To configure npm and pypi repositories you need to set 
  the packagecloud master token; for maven repoistories you will need your packagecloud accounts API token.
  Source: https://github.com/grantisdale/circleci-orbs
commands:
  configure:
    description: Configure packagecloud read token
    parameters:
      npm-repo:
        type: boolean
        default: false
      maven-gradle-repo:
        type: boolean
        default: false
      pypi-repo:
        type: boolean
        default: false
      username:
        type: string
        description: Packagecloud account username
      reponame: 
        type: string
        description: Packagecloud repository name
      mastertoken:
        description: The master token for your packagecloud repository
        type: string
      packagecloudtoken:
        description: Packagecloud API token
        type: string
    steps:
      - when:
          condition: << parameters.npm-repo >>
          steps:
            - run:
                name:  Create npm read token
                command: |
                  if [[ "<< parameters.mastertoken >>" ]]; then
                    curl -s https://<< parameters.mastertoken >>:@packagecloud.io/install/repositories/<< parameters.username >>/<< parameters.reponame >>/script.node.sh | bash
                  else
                    echo "Set packagecloud npm master token argument"
                    exit 1
                  fi  
      - when:
          condition: << parameters.maven-gradle-repo >>
          steps:
            - run:
                name:  Create maven release and snapshot read tokens and set up gradle
                command: |
                  if [[ "<< parameters.packagecloudtoken >>" ]]; then
                    UNIQUE_ID="`hostname -f`-<< parameters.reponame >>"
                    TOKEN_URL=https://<< parameters.packagecloudtoken >>:@packagecloud.io/api/v1/repos/<< parameters.username >>/<< parameters.reponame >>/master_tokens/<< parameters.mastertoken >>/read_tokens.json
                    curl -s -f -X POST -F "read_token[name]=${UNIQUE_ID}" $TOKEN_URL >/tmp/token.json
                    awk '{gsub("[{\"}]+", ""); gsub(",", "\n"); print $0}' /tmp/token.json > ~/token.params
                    mkdir -p ~/.gradle
                    echo "mavenPassword=<< parameters.packagecloudtoken >>" >> ~/.gradle/gradle.properties
                    echo "<< parameters.reponame >>.readtoken=`sed -n 's/value://p' ~/token.params`" >> ~/.gradle/gradle.properties
                    echo "<< parameters.reponame >> << parameters.mastertoken >> `sed -n 's/id://p' ~/token.params`" >> ~/revoke.list
                    cp ~/.gradle/gradle.properties .
                  else
                    echo "Set packagecloud API token argument"
                    exit 1
                  fi  
      - when:
          condition: << parameters.pypi-repo >>
          steps:
            - run:
                name: Create pypi read token
                command: |
                  if [[ "<< parameters.mastertoken >>" ]]; then
                    UNIQUE_ID=`hostname -f`
                    export READ_TOKEN=`curl -XPOST --data "name=${UNIQUE_ID}" https://<< parameters.mastertoken >>@packagecloud.io/install/repositories/<< parameters.username >>/<< parameters.reponame >>/tokens.text`
                    echo "export READ_TOKEN=${READ_TOKEN}" >> $BASH_ENV
                  else
                    echo "Set packagecloud pypi master token argument"
                    exit 1
                  fi 
  revoke:
    description: |
      Revoke read token(s) from packagecloud
    parameters:
      npm-repo:
        type: boolean
        default: false
      maven-gradle-repo:
        type: boolean
        default: false
      pypi-repo:
        type: boolean
        default: false
      username:
        type: string
        description: Packagecloud account username
      reponame: 
        type: string
        description: Packagecloud repository name
        default: ""
      packagecloudtoken:
        description: Packagecloud API token
        type: string
    steps:
      - when:
          condition: << parameters.npm-repo >>
          steps:
            - run:
                name: Revoke npm read token
                command: |
                  export PACKAGECLOUD_TOKEN=<< parameters.packagecloudtoken >>
                  package_cloud read_token destroy << parameters.username >>/<< parameters.reponame >> default/`hostname -f`
      - when:
          condition: << parameters.maven-gradle-repo >>
          steps:
            - run:
                name: Revoke maven-gradle read tokens
                command: |
                  while read revoke_entry; do
                    set $revoke_entry
                    REPO=$1
                    TOKEN=$2
                    ID=$3
                    curl -s -f -X DELETE https://<< parameters.packagecloudtoken >>:@packagecloud.io/api/v1/repos/<< parameters.username >>/${REPO}/master_tokens/${TOKEN}/read_tokens/${ID}
                  done < ~/revoke.list
      - when:
          condition: << parameters.pypi-repo >>
          steps:
            - run:
                name: Revoke pypi read token
                command: |
                  export PACKAGECLOUD_TOKEN=<< parameters.packagecloudtoken >>
                  package_cloud read_token destroy << parameters.username >>/<< parameters.reponame >> default/`hostname -f`

examples:
  use-packagecloud-npm-repository:
    description: |
      Create a read token and use with npm/yarn
    usage:
      jobs:
        build:
          docker:
          - image: circleci/node:10.16.3
          steps:
            - checkout
            - grantisdale/configure:
                npm-repo: true
                username: packagecloud-username
                reponame: packagecloud-npm-reponame
                mastertoken: "$MY-NPM-MASTER_TOKEN_VARIABLE"
                packagecloudtoken: "$MY-PACKAGECLOUD_API_TOKEN_VARIABLE"
            - run:
                name: Install and test
                command: |
                  yarn install
                  yarn test
            - run:
                name: Install packagecloud cli
                command: |
                  if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
                  $SUDO apt-get install ruby-full
                  $SUDO gem install rake
                  $SUDO gem install package_cloud
            - grantisdale/revoke:
                npm-repo: true
                username: packagecloud-username
                reponame: packagecloud-npm-reponame
                mastertoken: "$MY_NPM_MASTER_TOKEN"
                packagecloudtoken: "$MY_PACKAGECLOUD_API_TOKEN"
  use-packagecloud-maven-repository:
    description: |
      Create a read token and use with maven repositories, using gradle as build automation
    usage:
      jobs:
        build:
          machine:
            image: ubuntu-1604:201903-01
          steps:
            - checkout
            - grantisdale/configure:
                maven-gradle-repo: true
                username: packagecloud-username
                reponame: packgecloud-maven-releases-reponame
                mastertoken: "$MY_MAVEN_RELEASES_MASTER_TOKEN"
                packagecloudtoken: "$MY_PACKAGECLOUD_API_TOKEN"
            - grantisdale/configure:
                maven-gradle-repo: true
                username: packagecloud-username
                reponame: packgecloud-maven-snapshots-reponame
                mastertoken: "$MY_MAVEN_SNAPSHOTS_MASTER_TOKEN"
                packagecloudtoken: "$MY_PACKAGECLOUD_API_TOKEN"
            - run:
                name: Build
                command: |
                  ./gradlew
            - grantisdale/revoke:
                maven-gradle-repo: true
                username: packagecloud-username
                packagecloudtoken: "$MY_PACKAGECLOUD_API_TOKEN"

          

